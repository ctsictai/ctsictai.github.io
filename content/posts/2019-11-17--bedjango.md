---
title: Django Apprenticeship Study Part.6
date: "2019-11-17T21:30:03.284Z"
template: "post"
draft: false
slug: "/posts/django-part6/"
category: "Python/Django/AWS"
tags: -"Python/Django/AWS_S3"

description: "Django's handling image file "
socialImage: "/media/gutenberg.jpg"
---

# Django에서 AWS_S3에 Image 업로드 하는 방법

## 1.AWS IAM user 셋업

## 2.AWS S3 bucket 셋업

## 3.Django에서 boto3를 사용하여 S3와 연결 및 파일 업로드

# AWS IAM user set up

AWS 당연히 회원만 이용할 수 있는 서비스입니다. AWS 회원가입과 로그인을 먼저 하신 후 과정을 하신 후의 프로세스입니다.

## 1. AWS에서 IAM 페이지로 들어간다

Find Service에서 IAM을 치고 들어가는 것이 좋다

## 2. IAM resource에서 users 링크를 클릭한다

## 3. ADD user 버튼을 클릭하여 add user 페이지로 이동

- 유저 이름을 입력
- Programmatic Access 항목을 체크한다.
- "AWS management access console" 항목은 체크 하지 않도록 한다.

## 4. Permission 설정 페이지에서 새로운 permission policy을 추가 하도록 한다

- 새로운 permission policy를 추가하는 페이지에서 JSON 탭으로 이동해서 다음의 JSON을 입력하도록 한다.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObjectAcl",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:DeleteObject",
                "s3:PutObjectAcl"
            ],
            "Resource": [
                "arn:aws:s3:::example-bucket-name/*",
                "arn:aws:s3:::example-bucket-name"
            ]
        }
    ]
}
```

- Action에서 put, get, list, delete 항목은 CRUD를 제공하는 action을 명시한다
- example-bucket-name은 부분에서 내가 S3에서 생성할 버킷 이름으로 명시한다.

## 5. permission policy 페이지로 돌어가서 오른쪽 상단에 있는 refresh 버튼을 클릭하여 리스트를 refresh한 후 방금 만든 policy를 선택한후 next 버튼을 눌른다.

## 6. 새로운 유저 생성이 완료되면 csv 버튼을 클릭한다

- Access Key ID 와 Secret Access Key를 다운 받는다. 지금 다운 받지 않으면 다시 다운 받을 수 없으므로 꼭 다운 받도록 한다

# AWS S3 bucket 셋업

## 1. AWS S3페이지에서 "Create bucket"버튼을 클릭 한후 버켓 이름과 region 선택

- 그 다음 페이지 넘어가도 무방하고
- 그 다음 페이지(권한 설정)에서 block all public access를 uncheck를 한다.

## 2. 버켓 생성 완료 후 설정 페이지에서 상단의 Permission 탭에서 Bucket Policy 탭을 클릭 후 JSON을 입력한다.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1507637373230",
            "Effect": "Allow",
            "Principal": {
                "AWS": "user_arn"
            },
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
            "Resource": "arn:aws:s3:::bucket_name/*"
        },
        {
            "Sid": "Stmt1507637391106",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::bucket_name/*"
        }
    ]
}
```

- user_arn 설정
  IAM user의 ARN을 입력해야한다.
  ![ARN](https://stackoverflow.com/c/wecode/images/s/5f658489-6b2e-4e64-ba73-9998b0bacb7e.png)

- bucket_name은 각자 생성한 버켓의 이름이다.

- save버튼을 클릭하면 메세지 warning이 뜬다. 아까 버킷 생성이 public access를 줘서 보안 에러가 뜨는 것인데 지금은 무시해도 상관 없다.

## 3. CORS configurations 설정

버킷 정책 바로 옆의 버튼인 CORS 구성 버튼을 눌러서 CORS 설정을 해주도록 한다

```
<?xml version="1.0" encoding="UTF-8"?>
<CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
<CORSRule>
    <AllowedOrigin>*</AllowedOrigin>
    <AllowedMethod>GET</AllowedMethod>
    <MaxAgeSeconds>3000</MaxAgeSeconds>
    <ExposeHeader>ETag</ExposeHeader>
    <AllowedHeader>*</AllowedHeader>
</CORSRule>
</CORSConfiguration>
```

- opacity 먹은 글이 텍스트 편집기에 보이는데 그냥 무시하고 위의 내용 복사 붙여넣기 하면 된다.

# Django에서 boto3를 사용하여 S3와 연결 및 파일 업로드

## 1. boto3 설치

> pip install boto3

- AWS와 python과의 연결을 위한 라이브러리이다

## 2. boto3를 이용한 엔드포인트 만들기

```
import boto3

class FileView(View):

    s3_client = boto3.client(
        's3',
        aws_access_key_id="AKIASTLUR2MMQHRRSS6M",
        aws_secret_access_key="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"
    )

    def post(self, request):
        file = request.FILES['filename']

        self.s3_client.upload_fileobj(
            file,
            "s3-test-wecode",
            file.name,
            ExtraArgs={
                "ContentType": file.content_type
            }
        )

        return HttpResponse(status= 200)
```

- aws_acces_key_id와 aws_secret_access_key 값은 IAM user 생성 후 다운 받았던 csv 파일에 나와 있다.
- upload_fileobj 함수의 두번 째 인자는 파일을 업로드 하기 희망하는 버킷이름(내가 방금전에 생성한 버킷)
- 장고에서는 전송된 파일이 request.FILES를 통해 전달된다.
